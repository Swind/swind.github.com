<p>最近因為必須要示範如何將公司的 autoconf 與 automake 轉成 CMake，所以稍微研究了一下之前完全沒有用過得 <a class="reference external" href="http://www.cmake.org/cmake/help/cmake2.6docs.html#command:add_custom_command">add_custom_command</a> 跟 <a class="reference external" href="http://www.cmake.org/cmake/help/cmake2.6docs.html#command:add_custom_target">add_custom_target</a></p>
<div class="section" id="symbolic-link">
<h2>建立 symbolic link</h2>
<p>目前有一個需求是要建立 symbolic link 在某些特定的資料夾裡面。
由於 autotools 是可以直接使用 script 的語法，所以建立起來非常簡單。</p>
<pre class="code bash literal-block">
install-exec-hook:
     ln -fs <span class="k">$(</span>source_prefix<span class="k">)</span>/a <span class="k">$(</span>target_prefix<span class="k">)</span>/path1
     ln -fs <span class="k">$(</span>source_prefix<span class="k">)</span>/a <span class="k">$(</span>target_prefix<span class="k">)</span>/path2
     ln -fs <span class="k">$(</span>source_prefix<span class="k">)</span>/a <span class="k">$(</span>target_prefix<span class="k">)</span>/path3
     ln -fs <span class="k">$(</span>source_prefix<span class="k">)</span>/a <span class="k">$(</span>target_prefix<span class="k">)</span>/path4
     ln -fs <span class="k">$(</span>source_prefix<span class="k">)</span>/a <span class="k">$(</span>target_prefix<span class="k">)</span>/path5
</pre>
<p>這樣只要直接呼叫 make install-exec-hook 就可以建立 symbolic link 了。
但是如果要在 CMake 裡面作到一樣的事情要怎麼處理呢？</p>
<pre class="code cmake literal-block">
<span class="nb">Set</span><span class="p">(</span><span class="s">targets</span>
    <span class="o">${</span><span class="nv">target_prefix</span><span class="o">}</span><span class="s">/path1</span>
    <span class="o">${</span><span class="nv">target_prefix</span><span class="o">}</span><span class="s">/path2</span>
    <span class="o">${</span><span class="nv">target_prefix</span><span class="o">}</span><span class="s">/path3</span>
    <span class="o">${</span><span class="nv">target_prefix</span><span class="o">}</span><span class="s">/path4</span>
    <span class="o">${</span><span class="nv">target_prefix</span><span class="o">}</span><span class="s">/path5</span>
<span class="p">)</span>

<span class="nb">Function</span><span class="p">(</span><span class="s">Create_symbolic_link</span> <span class="s">source</span> <span class="s">target</span><span class="p">)</span>
    <span class="nb">Add_custom_command</span><span class="p">(</span>
        <span class="s">OUTPUT</span> <span class="o">${</span><span class="nv">target</span><span class="o">}</span>
        <span class="s">COMMAND</span> <span class="s">ln</span> <span class="s">-fs</span> <span class="o">${</span><span class="nv">source</span><span class="o">}</span> <span class="o">${</span><span class="nv">target</span><span class="o">}</span>
    <span class="p">)</span>
<span class="nb">Endfunction</span><span class="p">()</span>

<span class="nb">Foreach</span><span class="p">(</span><span class="s">target</span> <span class="s">targets</span><span class="p">)</span>
   <span class="nb">Create_symbolic_link</span><span class="p">(</span><span class="o">${</span><span class="nv">source_prefix</span><span class="o">}</span><span class="s">/a</span> <span class="o">${</span><span class="nv">target</span><span class="o">}</span><span class="p">)</span>
<span class="nb">Endforeach</span><span class="p">()</span>

<span class="nb">Add_custom_target</span><span class="p">(</span><span class="s">install-exec-hook</span> <span class="s">DEPENDS</span> <span class="o">${</span><span class="nv">targets</span><span class="o">}</span><span class="p">)</span>
</pre>
<p>因為 CMake 裡面沒有辦法像 shell script 一樣直接下指令，必須透過 Add_custom_command 或者是 Execute_process 等方式執行。
但是若又要跟 Target 建立相依性的話，似乎就一定得靠 Add_custom_command，因為他會設定一個 output file。
這樣就可以讓 Target 依賴這個檔案 ( 以我們的例子來說 Target 就是 install-exec-hook ) 來達到 make Target 就可以建立 symbolic link 的目的。</p>
<p>閃死人不償命的組合 ...</p>
<div class="figure">
<img alt="https://dl.dropboxusercontent.com/u/15537823/Blog/banner-of-the-stars_2.jpg" src="https://dl.dropboxusercontent.com/u/15537823/Blog/banner-of-the-stars_2.jpg" />
</div>
<blockquote>
<p>星たちよ</p>
<p>汝の命短き眷族の望みを聞くがよい。</p>
<p>我らの望みヽ</p>
<p>それは</p>
<p>汝の本降ちゆくを看取ること</p>
</blockquote></div>
