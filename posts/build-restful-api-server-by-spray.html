<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="utf-8"><meta name="title" content="用 Spray 建立一個簡單的 RESTful API Server | Corleonis"><meta name="description" content=""><meta name="author" content="Swind"><title>用 Spray 建立一個簡單的 RESTful API Server | Corleonis</title><!-- Le styles --><link href="../assets/css/bootstrap.css" rel="stylesheet" type="text/css"><link href="../assets/css/rst.css" rel="stylesheet" type="text/css"><link href="../assets/css/monokai.css" rel="stylesheet" type="text/css"><link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css"><link href="../assets/css/slides.css" rel="stylesheet" type="text/css"><link href="../assets/css/theme.css" rel="stylesheet" type="text/css"><link href="../assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css"><script src="../assets/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script src="../assets/js/slides.min.jquery.js" type="text/javascript"></script><script src="../assets/js/bootstrap.min.js" type="text/javascript"></script><!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../rss.xml"></head><body>
<!-- Menubar -->
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>        
        
            <a class="brand" href="../">
            Corleonis
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <div class="nav-collapse collapse">
                <ul class="nav"><li><a href="../archive.html">Archives</a>
            </li><li><a href="../categories/index.html">Tags</a>
            </li><li><a href="../stories/linux-note.html">Linux 筆記</a>

                </li></ul><ul class="nav pull-right"><li>
    <a href="build-restful-api-server-by-spray.rst">Source</a>
    </li>

                </ul></div>
        </div>
    </div>
</div>
<!-- End of Menubar -->
<div class="container-fluid" id="container-fluid">
    <!--Body content-->
    <div class="row-fluid">
    <div class="span2"></div>
    <div class="span8">
    
    <div class="postbox">
	
	
    <h1>用 Spray 建立一個簡單的 RESTful API Server</h1>


    <hr><small>
        Posted: 2012-11-06 20:11
        

        
          |  More posts about
            <a class="tag" href="../categories/scala.html"><span class="badge badge-info">Scala</span></a>
            <a class="tag" href="../categories/akka.html"><span class="badge badge-info">Akka</span></a>

    </small>
    <hr><p><a class="reference external" href="http://spray.cc/">Spray</a></p>
<p>最初是想要建立一個提供查詢服務的 RESTful API Server，可以讓 Client 的應用程式透過 RESTful API 查詢一些資料。
但是看來看去，用 Play2、Jersey、RESTEasy 等都蠻麻煩的，而且還需要使用 Web container（像 Tomcat、Jetty 等）。
所以才找到這個 Spray，而且又是用 Scala 開發的，實在沒有理由不試試看阿。 XD</p>
<p>若你連到官網看會發現他分成很多模組，老實說我也沒有詳細研究每個模組的功能。
因為 <a class="reference external" href="http://spray.cc/documentation/spray-can/">spray-can</a> 的範例看起來最簡單並且也符合我的需求，所以就直接用他了。</p>
<p>想瞭解更詳細內容的可以參考 <a class="reference external" href="https://github.com/spray/spray/tree/release-1.0-M2/examples/spray-can/simple-http-server/">spray-can 範例文件</a> 與 <a class="reference external" href="http://blog.cloudfoundry.com/2012/05/11/running-standalone-web-applications-on-cloud-foundry/">Running Standalone Web Applications on Cloud Foundry</a></p>
<!-- TEASER_END -->
<div class="section" id="id1">
<h2>環境準備</h2>
<p><a class="reference external" href="https://github.com/spray/spray/tree/release-1.0-M2/examples/spray-can/">spray-can 的範例</a> 已經有建立好一個簡單的 HttpServer 了，
所以我們先將 Spray 從 Github 上 Clone 下來。</p>
<pre class="code bash literal-block">
git clone git://github.com/spray/spray.git
</pre>
<p>然後複製出 spray/examples/spray-can/simple-http-server。
接著在 simple-http-server 底下，建立 build.sbt 讓 SBT 去 include 所需要的 Library。</p>
<p>順便設定 <a class="reference external" href="https://github.com/twitter/sbt-package-dist">package-dist</a>  這個 sbt plugin 所需要的資料。
package-dist 可以協助我們將 Project 所需要的 Library 與程式本身全部打包成一個 zip 檔。
但是這個 plugin 只能使用在 sbt 0.11.x，目前我還沒有看到可以在 0.12.x 的版本。
如果你不想用的話可以拿掉 Start 到 End 中間的內容。</p>
<p>而最下面的</p>
<blockquote>
EclipseKeys.createSrc := EclipseCreateSrc.Default + EclipsCreateSrc.Resource</blockquote>
<p>則是針對 sbteclipse 做的設定，讓 plugin 在產生 eclipse project 的時候可以將 src/main/resources 也加入 source folder。</p>
<pre class="code scala literal-block">
<span class="c1">//Start - For package-dist
</span><span class="k">import</span> <span class="nn">com.twitter.sbt._</span>

<span class="n">seq</span><span class="o">(</span><span class="nc">PackageDist</span><span class="o">.</span><span class="n">newSettings</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>

<span class="n">seq</span><span class="o">(</span><span class="nc">GitProject</span><span class="o">.</span><span class="n">gitSettings</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>

<span class="n">packageDistZipName</span> <span class="o">:=</span> <span class="s">"DictionaryServer.zip"</span>
<span class="c1">//End - For package-dist
</span>
<span class="n">organization</span> <span class="o">:=</span> <span class="s">"cc.spray"</span>

<span class="n">name</span> <span class="o">:=</span> <span class="s">"DictionaryServer"</span>

<span class="n">mainClass</span> <span class="n">in</span> <span class="o">(</span><span class="nc">Compile</span><span class="o">,</span> <span class="n">packageBin</span><span class="o">)</span> <span class="o">:=</span> <span class="nc">Some</span><span class="o">(</span><span class="s">"cc.spray.example.Main"</span><span class="o">)</span>

<span class="n">version</span> <span class="o">:=</span> <span class="s">"0.1.0-SNAPSHOT"</span>

<span class="n">scalaVersion</span> <span class="o">:=</span> <span class="s">"2.9.2"</span>

<span class="n">resolvers</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
<span class="s">"Typesafe repo"</span> <span class="n">at</span> <span class="s">"http://repo.typesafe.com/typesafe/releases/"</span><span class="o">,</span>
<span class="s">"spray repo"</span> <span class="n">at</span> <span class="s">"http://repo.spray.cc/"</span>
<span class="o">)</span>

<span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="s">"com.typesafe.akka"</span> <span class="o">%</span> <span class="s">"akka-actor"</span> <span class="o">%</span> <span class="s">"2.0.3"</span><span class="o">,</span>
    <span class="s">"cc.spray"</span> <span class="o">%</span> <span class="s">"spray-server"</span> <span class="o">%</span> <span class="s">"1.0-M2"</span><span class="o">,</span>
    <span class="s">"cc.spray"</span> <span class="o">%</span> <span class="s">"spray-can"</span> <span class="o">%</span> <span class="s">"1.0-M2"</span><span class="o">,</span>
    <span class="s">"org.slf4j"</span> <span class="o">%</span> <span class="s">"slf4j-api"</span> <span class="o">%</span> <span class="s">"1.6.6"</span><span class="o">,</span>
    <span class="s">"ch.qos.logback"</span> <span class="o">%</span> <span class="s">"logback-classic"</span> <span class="o">%</span> <span class="s">"1.0.7"</span>
<span class="o">)</span>

<span class="c1">//sbteclipse setting
</span><span class="nc">EclipseKeys</span><span class="o">.</span><span class="n">createSrc</span> <span class="o">:=</span> <span class="nc">EclipseCreateSrc</span><span class="o">.</span><span class="nc">Default</span> <span class="o">+</span> <span class="nc">EclipseCreateSrc</span><span class="o">.</span><span class="nc">Resource</span>
</pre>
<p>這邊注意一下 Spray 的版本問題，現在最新的 Example 程式碼是針對最新版本的 spray，但他們還沒有正式 release，
並且他們還換了 package name 等，所以我都是使用 1.0-M2 的版本，當然 Library 也是使用 1.0-M2。</p>
<p>到這邊，我們的環境就準備的差不多了。接下來，只要執行範例程式碼就可以有一個可以提供 Web Service 的 Http Server 了。</p>
</div>
<div class="section" id="start-http-server">
<h2>Start Http Server</h2>
<p>如果你對於 Akka 的用法有一點概念的話，那麼 Spray 對你來說應該是非常好上手的。</p>
<p>Main.scala 啟動一個 IoWorker Actor 負責 low-level 的 network I/O，
接下來將 IoWorker Actor 以及 Service Actor 傳入 HttpServer Actor並啟動 Http Server。
之後透過發送一個 HttpServer.Bind 的 Message 給 Server 設定 IP 與 Port。
這樣就完成了 Server 的啟動與設定了。</p>
<pre class="code scala literal-block">
<span class="c1">// we need an ActorSystem to host our application in
</span><span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"SimpleHttpServer"</span><span class="o">)</span>

<span class="c1">// the handler actor replies to incoming HttpRequests
</span><span class="k">val</span> <span class="n">handler</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">TestService</span><span class="o">])</span>

<span class="c1">// every spray-can HttpServer (and HttpClient) needs an IoWorker for low-level network IO
// (but several servers and/or clients can share one)
</span><span class="k">val</span> <span class="n">ioWorker</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">IoWorker</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">start</span><span class="o">()</span>

<span class="c1">// create and start the spray-can HttpServer, telling it that we want requests to be
// handled by our singleton handler
</span><span class="k">val</span> <span class="n">server</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span>
<span class="n">props</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpServer</span><span class="o">(</span><span class="n">ioWorker</span><span class="o">,</span> <span class="nc">MessageHandlerDispatch</span><span class="o">.</span><span class="nc">SingletonHandler</span><span class="o">(</span><span class="n">handler</span><span class="o">))),</span>
<span class="n">name</span> <span class="k">=</span> <span class="s">"http-server"</span>
<span class="o">)</span>

<span class="c1">// a running HttpServer can be bound, unbound and rebound
// initially to need to tell it where to bind to
</span><span class="n">server</span> <span class="o">!</span> <span class="nc">HttpServer</span><span class="o">.</span><span class="nc">Bind</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>

<span class="c1">// finally we drop the main thread but hook the shutdown of
// our IoWorker into the shutdown of the applications ActorSystem
</span><span class="n">system</span><span class="o">.</span><span class="n">registerOnTermination</span> <span class="o">{</span>
<span class="n">ioWorker</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
<span class="o">}</span>
</pre>
</div>
<div class="section" id="service">
<h2>提供 Service</h2>
<div class="section" id="http-request">
<h3>處理 Http Request</h3>
<p>提供 Service 的 Actor 會接收到 HttpRequest 的 Message，HttpRequest 的內容如下。</p>
<pre class="code scala literal-block">
<span class="k">case</span> <span class="k">class</span> <span class="nc">HttpRequest</span><span class="o">(</span>
            <span class="n">method</span>   <span class="k">:</span> <span class="kt">HttpMethod</span> <span class="o">=</span> <span class="nc">HttpMethods</span><span class="o">.</span><span class="nc">GET</span><span class="o">,</span>
            <span class="n">uri</span>      <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">,</span>
            <span class="n">headers</span>  <span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">HttpHeader</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">,</span>
            <span class="n">content</span>  <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">HttpContent</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">,</span>
            <span class="n">protocol</span> <span class="k">:</span> <span class="kt">HttpProtocol</span> <span class="o">=</span> <span class="n">`HTTP/1.1`</span><span class="o">)</span>
</pre>
<p>然後就可以利用 match 來處理各種不同的 HttpRequest，
例如有連線到 <a class="reference external" href="http://localhost:8080/">http://localhost:8080/</a> 的 GET 請求，
就會對應到第一個 HttpRequest "/"。</p>
<pre class="code scala literal-block">
<span class="k">protected</span> <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>

    <span class="k">case</span> <span class="nc">HttpRequest</span><span class="o">(</span><span class="nc">GET</span><span class="o">,</span> <span class="s">"/"</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">sender</span> <span class="o">!</span> <span class="n">index</span>

    <span class="k">case</span> <span class="nc">HttpRequest</span><span class="o">(</span><span class="nc">GET</span><span class="o">,</span> <span class="s">"/ping"</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">sender</span> <span class="o">!</span> <span class="n">response</span><span class="o">(</span><span class="s">"PONG!"</span><span class="o">)</span>

    <span class="k">case</span> <span class="nc">HttpRequest</span><span class="o">(</span><span class="nc">GET</span><span class="o">,</span> <span class="s">"/stats"</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="n">sender</span>
        <span class="n">context</span><span class="o">.</span><span class="n">actorFor</span><span class="o">(</span><span class="s">"../http-server"</span><span class="o">).</span><span class="n">ask</span><span class="o">(</span><span class="nc">HttpServer</span><span class="o">.</span><span class="nc">GetStats</span><span class="o">)(</span><span class="mf">1.</span><span class="n">second</span><span class="o">).</span><span class="n">onSuccess</span> <span class="o">{</span>

    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">HttpServer.Stats</span> <span class="o">=&gt;</span> <span class="n">client</span> <span class="o">!</span> <span class="n">statsPresentation</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">}</span>
</pre>
</div>
<div class="section" id="http-response">
<h3>建立 Http Response</h3>
<p>Response 的內容也非常好設定，以剛剛送回 sender 的 index 為例子，
Spray 使用一個 HttpResonse 的 case class 來代表 Response 的內容。
只要設定好 headers、body 與 status 就可以傳送回去 Sender 了。</p>
<pre class="code scala literal-block">
<span class="k">lazy</span> <span class="k">val</span> <span class="n">index</span> <span class="k">=</span> <span class="nc">HttpResponse</span><span class="o">(</span>
<span class="n">headers</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="nc">HttpHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"text/html"</span><span class="o">)),</span>
<span class="n">body</span> <span class="k">=</span>
  <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">Say</span> <span class="n">hello</span> <span class="n">to</span> <span class="o">&lt;</span><span class="n">i</span><span class="o">&gt;</span><span class="n">spray</span><span class="o">-</span><span class="n">can</span><span class="o">&lt;/</span><span class="n">i</span><span class="o">&gt;!&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Defined</span> <span class="n">resources</span><span class="o">:&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/ping"</span><span class="o">&gt;/</span><span class="n">ping</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/search"</span><span class="o">&gt;/</span><span class="n">search</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/stats"</span><span class="o">&gt;/</span><span class="n">stats</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/crash"</span><span class="o">&gt;/</span><span class="n">crash</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/timeout"</span><span class="o">&gt;/</span><span class="n">timeout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/timeout/timeout"</span><span class="o">&gt;/</span><span class="n">timeout</span><span class="o">/</span><span class="n">timeout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">"/stop"</span><span class="o">&gt;/</span><span class="n">stop</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;.</span><span class="n">toString</span><span class="o">.</span><span class="n">getBytes</span><span class="o">(</span><span class="s">"ISO-8859-1"</span><span class="o">),</span>
<span class="n">status</span> <span class="k">=</span> <span class="mi">200</span><span class="o">)</span>
</pre>
</div>
</div>
    
    <ul class="pager"><li class="previous">
            <a href="akka-2_0-note-6.html">← Previous post</a>
        </li>
        <li class="next">
            <a href="epubconverter-0_0_2.html">Next post →</a>
        </li>
    </ul><div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname ="swindgithub";
            var disqus_url="http://swind.code-life.info/posts/build-restful-api-server-by-spray.html";
        var disqus_title="用 Spray 建立一個簡單的 RESTful API Server";
        var disqus_identifier="cache/posts/2012-11-06-spray.html";
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>

    </div>
    </div> 
    <!--End of body content-->
</div>

<div class="footerbox">
    Contents © 2013 <a href="mailto:">Swind</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
</div>

    
    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"80%",maxHeight:"80%",scalePhotos:true});</script></body></html>