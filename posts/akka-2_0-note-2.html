<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Akka 2.0 筆記 (2) - 開始使用 Future | Corleonis</title>
<link href="../assets/css/bitter.css" rel="stylesheet" type="text/css">
<link href="../assets/css/main.css" rel="stylesheet" type="text/css">
<link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://swind.code-life.info/posts/akka-2_0-note-2.html">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    },
    displayAlign: 'left', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script><!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="Swind">
<meta property="og:site_name" content="Corleonis">
<meta property="og:title" content="Akka 2.0 筆記 (2) - 開始使用 Future">
<meta property="og:url" content="http://swind.code-life.info/posts/akka-2_0-note-2.html">
<meta property="og:description" content="以前再使用 Java Thread 的時候最困擾我的就是 Thread 之間的溝通。
要怎樣讓一個 Thread 去等待另外一個 Thread？要怎樣才能讓工作分配的平均？
最後是靠 BlockingQueue 才讓實作變得簡單一點，
不過想當然問題當然一大堆 ... Orz
所以想來實驗看看 Akka 的 Future 與 Router 到底是如何使用，與可以做到什麼事情。


Future
請">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2012-06-08T12:18:00+08:00">
<meta property="article:tag" content="Akka">
<meta property="article:tag" content="Scala">
</head>
<body>
    <section class="social"><ul>
<li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="https://github.com/Swind" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            
    <div class="post">
    
    <h1 class="p-name entry-title" itemprop="headline name">Akka 2.0 筆記 (2) - 開始使用 Future</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2012-06-08T12:18:00+08:00">2012-06-08 12:18</time>
            

            
          |  
        <a href="akka-2_0-note-2.rst" id="sourcelink">Source</a>

            </div>
            
        <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../categories/akka.html" rel="tag">Akka</a></li>
           <li><a class="tag p-category" href="../categories/scala.html" rel="tag">Scala</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<p>以前再使用 Java Thread 的時候最困擾我的就是 Thread 之間的溝通。
要怎樣讓一個 Thread 去等待另外一個 Thread？要怎樣才能讓工作分配的平均？
最後是靠 BlockingQueue 才讓實作變得簡單一點，
不過想當然問題當然一大堆 ... Orz</p>
<p>所以想來實驗看看 Akka 的 Future 與 Router 到底是如何使用，與可以做到什麼事情。</p>
<!-- TEASER_END -->
<div class="section" id="future">
<h2>Future</h2>
<p>請搭配 Akka 官網 <a class="reference external" href="http://doc.akka.io/docs/akka/2.0/scala/futures.html">Future</a> 服用。</p>
<p>看 Future 一定要看一下文件第一句話</p>
<blockquote>
In Akka, a Future is a data structure used to retrieve the result of some concurrent operation.</blockquote>
<p>是的，他只是一個 Data Structure 而已，<strong>Future 最主要的功能就是可以透過他取得 Actor 回傳的 message</strong>
也可以將他想成他代表我們未來會取得的回傳值，我想這也就是它叫做 Future 的原因了。</p>
<pre class="code scala"><a name="rest_code_6393150599074497a8524c5e6cb917b9-1"></a><span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mi">5</span> <span class="n">seconds</span><span class="o">)</span>
<a name="rest_code_6393150599074497a8524c5e6cb917b9-2"></a><span class="k">val</span> <span class="n">future</span> <span class="k">=</span> <span class="n">actor</span> <span class="o">?</span> <span class="n">msg</span> <span class="c1">// enabled by the "ask" import</span>
<a name="rest_code_6393150599074497a8524c5e6cb917b9-3"></a><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">future</span><span class="o">,</span> <span class="n">timeout</span><span class="o">.</span><span class="n">duration</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</pre>
<p>偷一下官網的範例，我們一行一行看上面的程式碼。</p>
<p>一開始的</p>
<pre class="code scala"><a name="rest_code_59b208ae801f472ba9b3ce290be2f8ba-1"></a><span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mi">5</span> <span class="n">seconds</span><span class="o">)</span>
</pre>
<p>就先忽略 implicit 吧，因為這邊還沒有用到 implicit 的特性。</p>
<p>現在只要知道他建立了一個 Timeout 物件，內容是 5 seconds，這個在之後設定 wait timeout 的時候會用到‧
為了避免無止盡的等待，在 Actor 裡面只要有關等待的操作都要給一個 Timeout 時間。</p>
<pre class="code scala"><a name="rest_code_26eaafddb4904fd383d834814c494a1a-1"></a><span class="k">val</span> <span class="n">future</span> <span class="k">=</span> <span class="n">actor</span> <span class="o">?</span> <span class="n">msg</span> <span class="c1">// enabled by the "ask" import</span>
</pre>
<p>這裡發一個 msg 給 actor ，特別需要注意的地方是這裡不是使用* ! <em>而是</em> ? <em>。
要使用這個 ? 需要 *import akka.pattern.ask</em>，跟 ! 不一樣的地方在於他會回傳一個 Future[Any] 物件</p>
<pre class="code scala"><a name="rest_code_eadaf9476f894a14ae6b041f27fb81ec-1"></a><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">future</span><span class="o">,</span><span class="n">timeout</span><span class="o">.</span><span class="n">duration</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</pre>
<p>最後使用 Await 來透過 Future 取得 Actor 的回傳值，並且設定一個 timeout 時間，如果時間到 Actor 沒有回傳任何東西的話，就會丟出一個 Timeout Exception。</p>
<div class="section" id="actor">
<h3>如果要等待很多個 Actor 回傳值呢？</h3>
<p>如果要將工作分派給多個 Actor 進行運作，那麼最直覺的想法就是</p>
<pre class="code scala"><a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-1"></a><span class="k">val</span> <span class="n">f1</span> <span class="k">=</span> <span class="n">actor1</span> <span class="o">?</span> <span class="n">msg1</span>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-2"></a><span class="k">val</span> <span class="n">f2</span> <span class="k">=</span> <span class="n">actor2</span> <span class="o">?</span> <span class="n">msg2</span>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-3"></a>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-4"></a><span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">f1</span><span class="o">,</span> <span class="mi">1</span> <span class="n">second</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-5"></a><span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">f2</span><span class="o">,</span> <span class="mi">1</span> <span class="n">second</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-6"></a>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-7"></a><span class="k">val</span> <span class="n">f3</span> <span class="k">=</span> <span class="n">actor3</span> <span class="o">?</span> <span class="o">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="o">)</span>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-8"></a>
<a name="rest_code_054c4caed3ae4e0a85b14ed54270f06c-9"></a><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">f3</span><span class="o">,</span> <span class="mi">1</span> <span class="n">second</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</pre>
<p>我先將工作發給 actor1 等他回傳，然後再發給 actor2 等待回傳，最後在將回傳結果發給 actor3。</p>
<p>為了要取得 a、b 而使用了 Await 兩次，這樣的作法非常沒有效率，因此有了 sequence 與 traverse 這兩個 function。</p>
<p>舉例來說，如果我有一個</p>
<pre class="code scala"><a name="rest_code_d8a6433bcb004ed780e7c82ade975a85-1"></a><span class="nc">List</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"Tony"</span><span class="o">,</span><span class="s">"Lion"</span><span class="o">,</span><span class="s">"Teddy"</span><span class="o">,</span><span class="s">"Brain"</span><span class="o">,</span><span class="s">"Jess"</span><span class="o">,</span><span class="s">"Kay"</span><span class="o">,</span><span class="s">"Michael"</span><span class="o">)</span>
</pre>
<p>並且想要這個 List 內所有字串的長度總和。</p>
<pre class="code scala"><a name="rest_code_c9d18dc7c46e4c34ab4982444aa45c48-1"></a><span class="k">val</span> <span class="n">list</span> <span class="k">=</span> <span class="nc">List</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">"Tony"</span><span class="o">,</span><span class="s">"Lion"</span><span class="o">,</span><span class="s">"Teddy"</span><span class="o">,</span><span class="s">"Brain"</span><span class="o">,</span><span class="s">"Jess"</span><span class="o">,</span><span class="s">"Kay"</span><span class="o">,</span><span class="s">"Michael"</span><span class="o">)</span>
<a name="rest_code_c9d18dc7c46e4c34ab4982444aa45c48-2"></a><span class="k">val</span> <span class="n">listOfFutures</span> <span class="k">=</span> <span class="n">list</span> <span class="n">map</span> <span class="o">{</span>
<a name="rest_code_c9d18dc7c46e4c34ab4982444aa45c48-3"></a>   <span class="n">name</span> <span class="k">=&gt;</span>
<a name="rest_code_c9d18dc7c46e4c34ab4982444aa45c48-4"></a>      <span class="o">(</span><span class="n">countActor</span> <span class="o">?</span> <span class="n">name</span><span class="o">).</span><span class="n">mapTo</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<a name="rest_code_c9d18dc7c46e4c34ab4982444aa45c48-5"></a><span class="o">}</span>
</pre>
<p>在這邊我們得到了一個型態為 List[Future[Int]] 的 listOfFutures，再來就可以使用 sequence 將其轉成 Future[List[Int]]
最後就可以使用 Await 來取得所有字串長度了，並且統計字數了。</p>
<pre class="code scala"><a name="rest_code_bde23bcb3f8e4b9e9d24ea515cc37ae4-1"></a><span class="k">val</span> <span class="n">futureList</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">(</span><span class="n">listOfFutures</span><span class="o">)</span>
<a name="rest_code_bde23bcb3f8e4b9e9d24ea515cc37ae4-2"></a><span class="k">val</span> <span class="n">lengthList</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">futureList</span><span class="o">,</span><span class="mi">1</span> <span class="n">second</span><span class="o">)</span>
</pre>
<p>而 sequence 與 traverse 兩個不一樣的地方在於說</p>
<p>sequence 接受一個 List[Future[A]] 轉成 Future[List[A]]。</p>
<pre class="code scala"><a name="rest_code_f9939cab631c4a2dacb7f956e5fa5d1d-1"></a><span class="k">val</span> <span class="n">futureList</span><span class="k">:</span><span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">sequence</span><span class="o">((</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">).</span><span class="n">toList</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">x</span><span class="k">=&gt;</span><span class="nc">Future</span><span class="o">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="o">)))</span>
</pre>
<p>而 traverse 則是接受一個 List[B] 與一個 function (B=&gt;Future[A]) 最後也是產生 Future[List[A]]</p>
<pre class="code scala"><a name="rest_code_4bad0d3e3bdf4978b65dd1dc20acb362-1"></a><span class="k">val</span> <span class="n">futureList</span><span class="k">:</span><span class="kt">Future</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">.</span><span class="n">traverse</span><span class="o">((</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">).</span><span class="n">toList</span><span class="o">)(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="o">))</span>
</pre>
<p>用 traverse 的好處在於少產生了中間過程的 List[Future[Int]] (至少我們的程式碼看不到，背後實際上有沒有我就不確定了，不過文件是這樣說的)，而直接產生了 Future[List[Int]]。</p>
<p>寫了這麼久，才寫這麼一點點 Orz ... 而且還完全沒有進入重點。</p>
</div>
</div>
</div>
        </div>
        
        <ul class="pager">
<li class="previous">
                <a href="akka-2_0-note-1.html" rel="prev" title="Akka 2.0 筆記 (1)">Previous post</a>
            </li>
            <li class="next">
                <a href="akka-2_0-note-3.html" rel="next" title="Akka 2.0 筆記(3) - Future 之實在不是我想要拖稿">Next post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="swindgithub",
            disqus_url="http://swind.code-life.info/posts/akka-2_0-note-2.html",
        disqus_title="Akka 2.0 \u7b46\u8a18 (2) - \u958b\u59cb\u4f7f\u7528 Future",
        disqus_identifier="cache/posts/2012-05-23-akka-note-2-eventstream.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        

    </div>

        
       <script>var disqus_shortname="swindgithub";(function(){var a=document.createElement("script");a.async=true;a.src="//"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer" role="contentinfo"><p>Contents © 2015 <a href="mailto:">Swind</a> - 
Powered by <a href="http://getnikola.com">Nikola</a> - 
Zen theme based in <a href="https://github.com/arusahni/website-template">Arusahni's website-template</a><br><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/ar/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="http://i.creativecommons.org/l/by-nc-sa/2.5/ar/88x31.png"></a></p>
            
        </footer>
</div>
    </section><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42855873-1', 'code-life.info');
  ga('send', 'pageview');

</script><script src="../assets/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="../assets/js/jquery.timeago.js" type="text/javascript"></script><!-- Social buttons --><div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
 <a class="addthis_button_more"><i class="icon-share-sign icon-2x"></i>    Share</a>
 <ul>
<li>
<a class="addthis_button_twitter"><i class="icon-twitter icon-2x"></i>    Twitter</a>
 </li>
<li>
<a class="addthis_button_google_plusone_share"><i class="icon-google-plus-sign icon-2x"></i>    Google+</a>
 </li>
<li>
<a class="addthis_button_linkedin"><i class="icon-linkedin icon-2x"></i>    Linkedin</a>
 </li>
<li>
<a class="addthis_button_facebook"><i class="icon-facebook-sign icon-2x"></i>    Facebook</a>
 </li>
</ul>
</div>
 <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script><!-- End of social buttons --><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
