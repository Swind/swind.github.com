<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="utf-8"><meta name="title" content="iSCSI target 開發筆記 | Corleonis"><meta name="description" content="iSCSI Target 開發筆記"><meta name="author" content="Swind"><title>iSCSI target 開發筆記 | Corleonis</title><!-- Le styles --><link href="../assets/css/bootstrap.css" rel="stylesheet" type="text/css"><link href="../assets/css/rst.css" rel="stylesheet" type="text/css"><link href="../assets/css/monokai.css" rel="stylesheet" type="text/css"><link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css"><link href="../assets/css/slides.css" rel="stylesheet" type="text/css"><link href="../assets/css/theme.css" rel="stylesheet" type="text/css"><link href="../assets/css/bootstrap-responsive.css" rel="stylesheet" type="text/css"><script src="../assets/js/jquery-1.7.2.min.js" type="text/javascript"></script><script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script><script src="../assets/js/slides.min.jquery.js" type="text/javascript"></script><script src="../assets/js/bootstrap.min.js" type="text/javascript"></script><!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --><!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../rss.xml"></head><body>
<!-- Menubar -->
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>        
        
            <a class="brand" href="../">
            Corleonis
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <div class="nav-collapse collapse">
                <ul class="nav"><li><a href="../archive.html">Archives</a>
            </li><li><a href="../categories/index.html">Tags</a>
            </li><li><a href="linux-note.html">Linux 筆記</a>

                </li></ul><ul class="nav pull-right"><li>
    <a href="iscsi_target_note.rst">Source</a>
    </li>

                </ul></div>
        </div>
    </div>
</div>
<!-- End of Menubar -->
<div class="container-fluid" id="container-fluid">
    <!--Body content-->
    <div class="row-fluid">
    <div class="span2"></div>
    <div class="span8">
    
    <h1>iSCSI target 開發筆記</h1>
    <div class="section" id="iscsi-target">
<h2>iSCSI Target 的設計</h2>
<p>iSCSI 裡面 Target 等於就是 Logic unit，而且底下的 disk 就是 logic unit number。
所以資料結構的呈現應該是</p>
<pre class="literal-block">
Target
    |
    |-------Lun0
    |-------Lun1
    ...
</pre>
<p>而 iSCSI initiator 的 PDU 是針對 Target 傳送的，也就是 Session 跟 Target 是成對的。</p>
<pre class="literal-block">
iSCSI initiator ====&lt;PDU&gt;====&gt; Session &lt;------&gt; Target
</pre>
<p>所以當 Session 收到 PDU 之後，就要拆開來，並且決定要將 SCSI Command 傳送到哪個 Lun。</p>
<!-- codeblock::c

typedef struct pi_target
{
    TAILQ_ENTRY(pi_target)  next;
    TAILQ_HEAD(, pi_lun)    luns;
    struct pi_conf      *conf;
    struct pi_auth_group    *auth_group;
    struct pi_portal_group  *portal_group;
    char            *iqn;
    char            *alias;
} pi_target; -->
<p>因此，我現在的 target 資料結構是長這樣。</p>
<p>next 是為了要串起此 iSCSI Target 內所有的 target，其實使用一個 Array 來儲存應該也是可以的。
而 luns 就是存放此 target 底下 Lun 的 List，這個應該就改成 Array 會比較合適了，不可能之後都用 List 的方式來尋訪。
這樣光是尋訪的時間就會太久了。</p>
<p>而 auth_group 跟 portal_group 就只是此 target 所需要得設定，負責管理對外的連線與認證的方式。</p>
<div class="section" id="lun">
<h3>lun 的設計</h3>
<!-- codeblock::c

typedef struct pi_lun
{
    TAILQ_ENTRY(pi_lun)     next;
    TAILQ_HEAD(, lun_option) options;
    struct pi_target        *target;
    int             lun;
    char            *backend;
    int             blocksize;
    char            *device_id;
    char            *path;
    char            *serial;
    int64_t         size;
} pi_lun; -->
<div class="section" id="iscsi-lun-struct">
<h4>iSCSI lun struct</h4>
<p>我想應該算是等價於 IPStor 中的 virtual_device。</p>
<p>所以這邊也是使用一個 List 來串連 lun，我想這個是沒有意義的，因為 lun 根本不需要知道其他 lun 的資訊。
反倒是比較重要的部份就是此 lun 的 implement 方式應該要如何被表達與使用。</p>
<p>例如增加一個 execute_scsi_cmd() 的 function，裡面傳遞 lun_cmd 的資料結構。
這樣他就可以執行了？</p>
<pre class="literal-block">
pi_lun                            vdev_pass
   |                                  |
   |----- execute_scsi_cmd()---------&gt;|
</pre>
<p>那麼這個 pi_lun 資料結構所存在的意義主要就是將 iSCSI 才會有的東西放在這裡。
例如說它屬於哪個 target，還有此 disk 的型態等。</p>
<p>inqury 畢竟也是以 SCSI Command 的方式來呈現，最後都還是將資料寫入 data 這個空間裡面。
所以我想應該不需要另外增加 inqury 的 function，應該順其自然將所有的 lun_cmd 都傳入 execute_scsi 來執行。</p>
</div>
<div class="section" id="iscsi-lun">
<h4>iSCSI lun 的初始化</h4>
<p>在 iSCSI config 中應該紀錄著 iSCSI lun 初始化內容，包括他應該對應的 Path 與型態。
因此在這邊初始化的時候，就應該也要把 <strong>virtual device struct</strong> 的部份也一起初始化。</p>
<pre class="literal-block">
讀取 Config file
        |
建立 Target struct
        |
建立 Target 底下的 iSCSI lun，根據 lun 的型態
        |
建立 iSCSI lun 實際對應的 virtual device
========|=====================================
初始化 virtual device 建立相對應的 implement 方式 (ex. pass through)
(若是 pass through 就應該要包括取得 cam_dev 與 ccb 的動作)
</pre>
</div>
<div class="section" id="virtual-device-implement">
<h4>virtual device implement 部份的初始化</h4>
<p>每一種 virtual device implement 的初始化方式應該都不一樣，
但是最重要得部份就是要提供一個物件讓 iSCSI lun 可以將 SCSI Command 轉發過來。</p>
</div>
<div class="section" id="virtual-device-implement-struct">
<h4>virtual device implement struct</h4>
<p>解決了 iSCSI 上面 lun 的表現之後，再來就是在 vdev 背後的情況了。
雖然說 pi_lun 的 <strong>execute_scsi_cmd()</strong> 是直接指到 vdev_pass 的 execute_scsi_cmd()，
但是還欠缺執行所需要的資料，例如 File Path 等。所以</p>
<pre class="literal-block">
pi_lun                                                  vdev_pass
  |                                                         |
  |- (uint8_t*) vdev_info                                   |
  |--------- execute_scsi_cmd(uint8_t* vdev_info)--------&gt;  |
</pre>
<p>讓 vdev_pass 裡面的 execute_scsi_cmd 自行轉換 vdev_info 的型態變成他自己想要的。</p>
</div>
</div>
</div>
<div class="section" id="iscsi-test-data">
<h2>iSCSI 的 Test Data</h2>
<p>iSCSI login - session type = normal</p>
<div class="section" id="login-init-handler">
<h3>login init handler</h3>
<pre class="literal-block">
********** login handler ***********
BHS dump
0x000000: 43 81 00 00 00 00 00 7f C.......
0x000008: 40 00 01 37 00 01 00 00 @..7....
0x000010: 00 00 00 01 00 01 00 00 ........
0x000018: 00 00 00 01 00 00 00 01 ........
0x000020: 00 00 00 00 00 00 00 00 ........
0x000028: 00 00 00 00 00 00 00 00 ........

Data dump
0x000000: 49 6e 69 74 69 61 74 6f Initiato
0x000008: 72 4e 61 6d 65 3d 69 71 rName=iq
0x000010: 6e 2e 31 39 39 31 2d 30 n.1991-0
0x000018: 35 2e 63 6f 6d 2e 6d 69 5.com.mi
0x000020: 63 72 6f 73 6f 66 74 3a crosoft:
0x000028: 73 77 69 6e 64 2d 70 63 swind-pc
0x000030: 00 53 65 73 73 69 6f 6e .Session
0x000038: 54 79 70 65 3d 4e 6f 72 Type=Nor
0x000040: 6d 61 6c 00 54 61 72 67 mal.Targ
0x000048: 65 74 4e 61 6d 65 3d 69 etName=i
0x000050: 71 6e 2e 32 30 31 32 2d qn.2012-
0x000058: 30 36 2e 63 6f 6d 2e 65 06.com.e
0x000060: 78 61 6d 70 6c 65 3a 74 xample:t
0x000068: 61 72 67 65 74 30 00 41 arget0.A
0x000070: 75 74 68 4d 65 74 68 6f uthMetho
0x000078: 64 3d 4e 6f 6e 65 00 00 d=None..
</pre>
<pre class="literal-block">
********** login handler response***********

Send PDU BHS dump
0x000000: 23 81 00 00 00 00 00 00 #.......
0x000008: 40 00 01 37 00 01 00 00 @..7....
0x000010: 00 00 00 01 00 00 00 00 ........
0x000018: 00 00 00 00 00 00 00 00 ........
0x000020: 00 00 00 00 00 00 00 00 ........
0x000028: 00 00 00 00 00 00 00 00 ........

Send PDU Data dump
0x000000: 54 61 72 67 65 74 50 6f TargetPo
0x000008: 72 74 61 6c 47 72 6f 75 rtalGrou
0x000010: 70 54 61 67 3d 31 00 41 pTag=1.A
0x000018: 75 74 68 4d 65 74 68 6f uthMetho
0x000020: 64 3d 4e 6f 6e 65 00 54 d=None.T
0x000028: 61 72 67 65 74 41 6c 69 argetAli
0x000030: 61 73 3d 54 61 72 67 65 as=Targe
0x000038: 74 20 66 6f 72 20 74 65 t for te
0x000040: 73 74 00                st.
</pre>
<div class="section" id="login-negotiate-handler">
<h4>login negotiate handler</h4>
<pre class="literal-block">
********** login negotiate handler ***********

BHS dump

0x000000: 43 87 00 00 00 00 01 2c C......,
0x000008: 40 00 01 37 00 01 00 00 @..7....
0x000010: 00 00 00 01 00 01 00 00 ........
0x000018: 00 00 00 01 00 00 00 01 ........
0x000020: 00 00 00 00 00 00 00 00 ........
0x000028: 00 00 00 00 00 00 00 00 ........

Data dump

0x000000: 48 65 61 64 65 72 44 69 HeaderDi
0x000008: 67 65 73 74 3d 4e 6f 6e gest=Non
0x000010: 65 2c 43 52 43 33 32 43 e,CRC32C
0x000018: 00 44 61 74 61 44 69 67 .DataDig
0x000020: 65 73 74 3d 4e 6f 6e 65 est=None
0x000028: 2c 43 52 43 33 32 43 00 ,CRC32C.
0x000030: 45 72 72 6f 72 52 65 63 ErrorRec
0x000038: 6f 76 65 72 79 4c 65 76 overyLev
0x000040: 65 6c 3d 32 00 49 6e 69 el=2.Ini
0x000048: 74 69 61 6c 52 32 54 3d tialR2T=
0x000050: 4e 6f 00 49 6d 6d 65 64 No.Immed
0x000058: 69 61 74 65 44 61 74 61 iateData
0x000060: 3d 59 65 73 00 4d 61 78 =Yes.Max
0x000068: 52 65 63 76 44 61 74 61 RecvData
0x000070: 53 65 67 6d 65 6e 74 4c SegmentL
0x000078: 65 6e 67 74 68 3d 36 35 ength=65
0x000080: 35 33 36 00 4d 61 78 42 536.MaxB
0x000088: 75 72 73 74 4c 65 6e 67 urstLeng
0x000090: 74 68 3d 32 36 32 31 34 th=26214
0x000098: 34 00 46 69 72 73 74 42 4.FirstB
0x0000a0: 75 72 73 74 4c 65 6e 67 urstLeng
0x0000a8: 74 68 3d 36 35 35 33 36 th=65536
0x0000b0: 00 4d 61 78 43 6f 6e 6e .MaxConn
0x0000b8: 65 63 74 69 6f 6e 73 3d ections=
0x0000c0: 33 32 00 44 61 74 61 50 32.DataP
0x0000c8: 44 55 49 6e 4f 72 64 65 DUInOrde
0x0000d0: 72 3d 59 65 73 00 44 61 r=Yes.Da
0x0000d8: 74 61 53 65 71 75 65 6e taSequen
0x0000e0: 63 65 49 6e 4f 72 64 65 ceInOrde
0x0000e8: 72 3d 59 65 73 00 44 65 r=Yes.De
0x0000f0: 66 61 75 6c 74 54 69 6d faultTim
0x0000f8: 65 32 57 61 69 74 3d 30 e2Wait=0
0x000100: 00 44 65 66 61 75 6c 74 .Default
0x000108: 54 69 6d 65 32 52 65 74 Time2Ret
0x000110: 61 69 6e 3d 36 30 00 4d ain=60.M
0x000118: 61 78 4f 75 74 73 74 61 axOutsta
0x000120: 6e 64 69 6e 67 52 32 54 ndingR2T
0x000128: 3d 31 36 00             =16.
</pre>
<pre class="literal-block">
********** login negotiate handler ***********

Send PDU bhs dump
0x000000: 23 87 00 00 00 00 00 00 #.......
0x000008: 40 00 01 37 00 01 ba dd @..7....
0x000010: 00 00 00 01 00 00 00 00 ........
0x000018: 00 00 00 01 00 00 00 00 ........
0x000020: 00 00 00 00 00 00 00 00 ........
0x000028: 00 00 00 00 00 00 00 00 ........

Send PDU data dump

0x000000: 44 65 66 61 75 6c 74 54 DefaultT
0x000008: 69 6d 65 32 57 61 69 74 ime2Wait
0x000010: 3d 30 00 44 65 66 61 75 =0.Defau
0x000018: 6c 74 54 69 6d 65 32 52 ltTime2R
0x000020: 65 74 61 69 6e 3d 36 30 etain=60
0x000028: 00 48 65 61 64 65 72 44 .HeaderD
0x000030: 69 67 65 73 74 3d 4e 6f igest=No
0x000038: 6e 65 00 4d 61 78 52 65 ne.MaxRe
0x000040: 63 76 44 61 74 61 53 65 cvDataSe
0x000048: 67 6d 65 6e 74 4c 65 6e gmentLen
0x000050: 67 74 68 3d 36 35 35 33 gth=6553
0x000058: 36 00 44 61 74 61 44 69 6.DataDi
0x000060: 67 65 73 74 3d 4e 6f 6e gest=Non
0x000068: 65 00                   e.
</pre>
</div>
<div class="section" id="full-feature">
<h4>full feature</h4>
<pre class="literal-block">
BHS dump

0x000000: 01 c0 00 00 00 00 00 00 ........
0x000008: 00 00 00 00 00 00 00 00 ........
0x000010: 00 00 00 00 00 00 00 10 ........
0x000018: 00 00 00 00 00 00 00 02 ........
0x000020: a0 00 00 00 00 00 00 00 ........
0x000028: 00 10 00 00 00 00 00 00 ........

/root/Program/iSCSI/src/session_reader.c:  86:set_read_data_segment_iovec: Data Segment length is 0
/root/Program/iSCSI/src/session_reader.c: 138:read_to_iovec: PDU read from 6 with length 0

Data dump
</pre>
</div>
</div>
</div>

    </div>
    </div> 
    <!--End of body content-->
</div>

<div class="footerbox">
    Contents © 2013 <a href="mailto:">Swind</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
</div>

    
    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"80%",maxHeight:"80%",scalePhotos:true});</script></body></html>